# go_payment_bot

Telegram-бот для платного размещения объявлений в темах (topics) супергрупп. Поддерживает несколько групп и тем, встроенную антиспам-модерацию, предпросмотр перед публикацией и автоматическое удаление просроченных постов.

## Как работает

```
Пользователь пишет в тему → Бот удаляет сообщение → Предлагает оплату в ЛС →
→ (опционально) Сбор email → Оплата через Telegram Payments →
→ Пользователь отправляет контент → Предпросмотр → Подтверждение → Публикация в тему
```

По истечении срока размещения бот автоматически удаляет пост.

## Возможности

- **Мультигрупповая поддержка** — бот работает с несколькими группами и темами, каждая со своими настройками (цена, срок, лимиты)
- **Telegram Payments** — встроенная оплата через платёжных провайдеров Telegram
- **Предпросмотр** — пользователь видит объявление перед публикацией и может загрузить заново
- **Фото и media group** — поддержка текста, одного фото или нескольких фото (media group)
- **Антиспам** — автоматическое удаление сообщений с телефонами, ссылками и контактами во всех топиках группы
- **Белый список доменов** — разрешённые ссылки (маркетплейсы, YouTube и др.) не блокируются
- **Модерация** — опциональная ручная модерация объявлений перед публикацией (per-topic)
- **Автоудаление** — просроченные посты удаляются автоматически (проверка каждые 5 минут)
- **Сбор email** — опциональный запрос email у пользователя перед оплатой
- **Тестовый режим** — команда `/testpay` для тестирования без реальной оплаты

## Стек

- Go 1.25
- PostgreSQL (pgx v5, pgxpool)
- [go-telegram/bot](https://github.com/go-telegram/bot) — Telegram Bot API
- Docker + Docker Compose

## Структура проекта

```
go_payment_bot/
├── main.go                  # Точка входа, регистрация хэндлеров
├── config/
│   └── config.go            # Конфигурация из переменных окружения
├── database/
│   ├── database.go          # Подключение к PostgreSQL
│   ├── models.go            # Модели: User, Topic, Post, Payment и др.
│   └── queries.go           # SQL-запросы
├── handlers/
│   └── handlers.go          # Обработка сообщений, callback, оплат
├── messages/
│   └── messages.go          # Шаблоны текстов бота
├── moderation/
│   └── detector.go          # Детектор спама (телефоны, ссылки, контакты)
├── migrations/
│   ├── 000001_init.up.sql           # Основная схема БД
│   ├── 000001_init.down.sql
│   ├── 000002_spam_violations.up.sql
│   ├── 000002_spam_violations.down.sql
│   ├── 000003_allowed_domains.up.sql
│   └── 000003_allowed_domains.down.sql
├── Dockerfile
├── docker-compose.yml
├── Makefile
├── .env.example
└── .gitignore
```

## Запуск

### Локально

```bash
cp .env.example .env
# заполнить .env

# применить миграции
make migrate-up

# запуск
go mod tidy
go run .
```

### Docker

```bash
cp .env.example .env
# заполнить .env

docker-compose up -d
```

## Настройка

### Переменные окружения

| Переменная                | Описание                                     | По умолчанию    |
|---------------------------|----------------------------------------------|-----------------|
| `DATABASE_URL`            | Строка подключения к PostgreSQL              | — (обязательно) |
| `BOT_TOKEN`               | Токен от @BotFather                          | — (обязательно) |
| `PAYMENT_PROVIDER_TOKEN`  | Токен платёжного провайдера Telegram         | — (обязательно) |
| `DEFAULT_PRICE`           | Цена по умолчанию в копейках (50000 = 500 ₽) | `50000`         |
| `DEFAULT_DURATION_DAYS`   | Срок размещения по умолчанию (дни)           | `7`             |
| `DEFAULT_MAX_TEXT_LENGTH` | Максимальная длина текста объявления         | `1000`          |
| `DEFAULT_MAX_PHOTOS`      | Максимальное количество фото                 | `5`             |
| `TEST_MODE`               | Включить тестовый режим (`true`/`false`)     | `false`         |

### Настройка тем

Темы (topics) управляются через базу данных. Каждая тема имеет индивидуальные параметры: цену, срок размещения, лимиты на текст и фото, флаг модерации. Для добавления новой темы создайте записи в таблицах `groups` и `topics`.

### Белый список доменов

Миграция `000003_allowed_domains` создаёт таблицу `allowed_domains` с начальным набором разрешённых доменов (Ozon, Wildberries, YouTube и др.). Управление — через БД. Список перезагружается автоматически каждый час.

## Получение ID

**BOT_TOKEN** — @BotFather → `/newbot` или `/mybots`

**PAYMENT_PROVIDER_TOKEN** — @BotFather → `/mybots` → выбрать бота → Payments → подключить провайдера

**GROUP_ID** (для таблицы `groups`) — добавить бота в группу → отправить сообщение → открыть `https://api.telegram.org/bot<TOKEN>/getUpdates` → найти `chat.id`

**TOPIC_ID** (для таблицы `topics`) — ПКМ по теме → «Скопировать ссылку» → число после последнего `/`

## Миграции

```bash
# Применить все миграции
make migrate-up

# Откатить последнюю миграцию
make migrate-down

# Создать новую миграцию
make migrate-create
```

Требуется утилита [golang-migrate](https://github.com/golang-migrate/migrate).

## Схема БД

Основные таблицы: `groups`, `topics`, `users`, `posts`, `pending_posts`, `payments`, `spam_violations`, `allowed_domains`.

Состояния пользователя (`user_state`): `none` → `waiting_email` → `waiting_payment` → `waiting_content` → `waiting_confirm` → `waiting_moderation` (опционально) | `banned`.
